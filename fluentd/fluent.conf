<source>
  @type  forward
  port 24224
  bind 0.0.0.0
</source>

#------------------------------------------------------
# REFORMAT EVENT FROM REVERSE-PROXY (TRAEFIK)
#------------------------------------------------------
<filter chameleon.reverse-proxy>
  @type parser
  key_name log
  <parse>
    @type regexp
    expression /\s*level=(?<level>\w+)\s*msg="(?<message>.+)"/
    types level:string
    types message:string
  </parse>
</filter>

#--------------------------------------------------------
<match chameleon.**>
  @type copy

  #------------------------------------------------------
  # OUTPUT TO JSON FILE
  #------------------------------------------------------
  <store>
    @type file
    path /fluentd/log/chameleon_json_%Y%m%d
    path_suffix ".json"
    append true
    include_tag_key true
    include_time_key true
    <buffer>
      timekey 1d
      timekey_wait 10m
      timekey_use_utc false
    </buffer>
    <format>
      @type json
    </format>
  </store>

  #------------------------------------------------------
  # OUTPUT TO CSV FILE
  #------------------------------------------------------
  <store>
    @type file
    path /fluentd/log/chameleon_csv_%Y%m%d
    append true
    include_tag_key true
    include_time_key true
    <buffer>
      timekey 1d
      timekey_wait 10m
      timekey_use_utc false
    </buffer>
    <format>
      @type csv
      fields time,tag,level,message
      force_quotes false
      delimiter ", "
    </format>
  </store>

  #------------------------------------------------------
  # REWRITE TAG BY PREFIX LEVEL
  #------------------------------------------------------
  <store>
    @type rewrite_tag_filter
    <rule>
      key level
      pattern /^(\w+)$/
      tag $1.${tag}
    </rule>
  </store>
</match>

#------------------------------------------------------------------
# MATCH TAGS WITH LEVEL PREFIX - ERROR + WARN TO EMAIL, REST THROW
#------------------------------------------------------------------
<match error.** warn.**>
  @type mail
  host "#{ENV['LOGGING_MAIL_SERVER']}"
  port 25
  from Chameleon_Server
  to "#{ENV['LOGGING_MAIL_RECIPIENT']}"
  user "#{ENV['LOGGING_MAIL_USER']}"
  password "#{ENV['LOGGING_MAIL_PASSWORD']}"
  time_key time
  time_format  %d.%m.%Y %T %z
  subject Chameleon server: %s
  subject_out_keys tag
  message %s\n\nlevel: %s\n\n%s
  message_out_keys time,level,message
</match>

<match *.chameleon.**>
  @type null
</match>
